# Windows麦克风问题排查指南
# Windows Microphone Troubleshooting Guide

本文档帮助解决Windows系统上麦克风无法录音的问题。

## 症状
- 客户端能正常启动
- 服务器连接正常
- 录音时音频能量为0.000000
- 转写成功但返回0个片段(因为是静音)

## 排查步骤

### 1. Windows隐私设置检查

#### 1.1 基础权限
打开 `设置 → 隐私和安全性 → 麦克风`:
- ✅ 麦克风访问权限: **开启**
- ✅ 让应用访问麦克风: **开启**
- ✅ 让桌面应用访问麦克风: **开启**

#### 1.2 验证方法
在"最近的活动"中应该能看到Python的麦克风访问请求。

---

### 2. 系统级麦克风测试

#### 2.1 Windows声音设置测试
1. 右键点击任务栏音量图标 → "声音设置"
2. 找到"输入"部分
3. 选择你的麦克风设备
4. **对着麦克风说话**,观察音量条是否跳动

**如果音量条不跳动** → 说明是系统/硬件问题,继续往下排查
**如果音量条跳动** → 说明硬件正常,是Python配置问题,跳到第5步

#### 2.2 检查麦克风状态
1. 右键音量图标 → "声音设置" → "更多声音设置"
2. 切换到"录制"选项卡
3. 检查你的麦克风:
   - 是否显示为"默认设备"(绿色勾)
   - 是否被禁用(灰色)
   - 右键 → "属性" → "级别",确保音量不是0

---

### 3. Realtek音频管理器检查

#### 3.1 打开Realtek HD音频管理器
方法一:
- 开始菜单搜索"Realtek"
- 或在任务栏找Realtek图标(可能隐藏在系统托盘)

方法二:
- 控制面板 → 硬件和声音 → Realtek HD音频管理器

#### 3.2 检查设置
1. **麦克风选项卡**:
   - 确保麦克风未静音
   - 调整"麦克风音量"至80%以上
   - 尝试开启"麦克风增强"(Microphone Boost)

2. **连接器设置**:
   - 确认前面板/后置麦克风连接器已启用
   - 有些Realtek驱动需要手动检测接口

3. **高级设置**:
   - "默认格式"设置为 `16位, 16000Hz` 或 `16位, 44100Hz`

---

### 4. 麦克风硬件检查

#### 4.1 物理连接
- 麦克风是否插入正确的接口(粉色的麦克风接口,不是绿色的耳机接口)
- 如果是USB麦克风,尝试换一个USB口
- 如果是笔记本,确认使用的是外接麦克风还是内置麦克风

#### 4.2 硬件测试
- 在其他设备上测试麦克风是否工作
- 或在Windows"录音机"应用中测试录音

---

### 5. PyAudio设备配置

#### 5.1 列出所有音频设备
运行测试脚本:
```bash
python scripts\windows\test_all_microphones.py
```

这会自动测试所有输入设备,找出哪个能工作。

#### 5.2 指定输入设备
如果测试发现其他设备可以工作,需要修改客户端代码:

编辑 `client/client.py`,在 `_record_impl` 方法中的 `p.open()` 调用添加参数:
```python
stream = p.open(
    format=pyaudio.paInt16,
    channels=1,
    rate=sample_rate,
    frames_per_buffer=frames_per_buffer,
    input=True,
    input_device_index=DEVICE_NUMBER  # 添加这行,替换为工作的设备编号
)
```

---

### 6. 驱动程序问题

#### 6.1 更新Realtek驱动
1. 访问主板制造商网站(华硕/技嘉/微星等)
2. 下载最新的Realtek音频驱动
3. 或使用Windows Update自动更新

#### 6.2 重新安装音频驱动
1. 设备管理器 → 声音、视频和游戏控制器
2. 右键Realtek音频设备 → 卸载设备
3. 勾选"删除此设备的驱动程序软件"
4. 重启电脑,Windows会自动重新安装驱动

---

### 7. 常见特殊情况

#### 7.1 笔记本电脑
某些笔记本的麦克风阵列可能需要特殊配置:
- 在Realtek设置中禁用"噪声抑制"和"回声消除"
- 尝试使用单个麦克风而不是麦克风阵列

#### 7.2 USB麦克风
- USB麦克风在设备列表中会显示为独立设备
- 可能需要在 `config/client_config.json` 中明确指定设备索引

#### 7.3 蓝牙麦克风
- 蓝牙设备可能有延迟或采样率不匹配问题
- 建议使用有线麦克风以获得最佳效果

---

## 快速诊断命令

```bash
# 1. 测试所有麦克风设备
python scripts\windows\test_all_microphones.py

# 2. 详细的麦克风测试(交互式)
python scripts\windows\test_microphone.py

# 3. 启用麦克风访问权限(管理员)
scripts\windows\enable_microphone_access.bat
```

---

## 成功标准

测试成功时,应该看到:
```
音量: ████████████ 1250
录音分析:
  平均能量: 0.035000 或更高
  最大值: 0.200000 或更高
✓ 麦克风工作正常!
```

---

## 仍然无法解决?

如果以上步骤都尝试过仍无法解决,可能需要:

1. **检查BIOS设置**:
   某些主板可能在BIOS中禁用了板载音频

2. **检查Windows服务**:
   确保"Windows Audio"服务正在运行
   - `Win + R` → 输入 `services.msc`
   - 找到"Windows Audio",确保状态为"正在运行"

3. **使用外接USB声卡**:
   如果板载声卡有问题,考虑购买USB声卡/麦克风

4. **系统还原**:
   如果之前可以工作,尝试系统还原到之前的还原点

---

## 联系支持

如果问题持续存在,请提供以下信息:
- Windows版本 (`Win + R` → `winver`)
- 音频设备型号
- `python scripts\windows\test_all_microphones.py` 的完整输出
- 设备管理器中的音频设备截图
